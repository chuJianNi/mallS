<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
		<meta name="description" content="">
		<meta name="author" content="">
		<link rel="icon" href="/static/pic/favicon.ico">

		<title>商城</title>

		<!-- Bootstrap core CSS -->
		<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

		<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
		<link href="/assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

		<!-- Custom styles for this template -->
		<link href="/static/css/dashboard.css" rel="stylesheet">

		<!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
		<!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
		<script src="/assets/js/ie-emulation-modes-warning.js"></script>

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
			<script src="https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
			<script src="https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		<!--datatables  CSS -->
		<link href="http://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css" rel="stylesheet">
		<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/css/bootstrap-dialog.min.css" rel="stylesheet">
	</head>

	<body>

		<nav class="navbar navbar-inverse navbar-fixed-top">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#">商城管理</a>
				</div>
				<div id="navbar" class="navbar-collapse collapse">
					<ul class="nav navbar-nav navbar-right">
						<li><a href="#">设置</a></li>
						<li><a href="#">帮助</a></li>
					</ul>
					<form class="navbar-form navbar-right">
						<input type="text" class="form-control" placeholder="查询...">
					</form>
				</div>
			</div>
		</nav>

		<div class="container-fluid">
			<div class="row">
				<div class="col-sm-3 col-md-2 sidebar">
					<ul class="nav nav-sidebar">
						<li class="active"><a href="/index/index/index">用户管理 <span class="sr-only">(current)</span></a></li>
					</ul>
					<ul class="nav nav-sidebar">
						<li><a href="/index/index/goods">商品管理</a></li>
					</ul>
				</div>
				<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">

					<!-- Button trigger modal -->
					<button type="button" class="btn btn-info" data-toggle="modal" data-target="#myModal">
						添加新用户
					</button>
					<!-- Modal -->
					<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
								<div class="modal-header bg-info">
									<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
									<h4 class="modal-title" id="myModalLabel">添加用户</h4>
								</div>
								<div class="modal-body">
									<form class="form-horizontal" id="addForm" method="post">
										<div class="form-group">
											<label class="col-sm-2 control-label">账号</label>
											<div class="col-sm-9">
												<input type="text" class="form-control" id="inputAccount" name="inputAccount" placeholder="账号" required>
											</div>
											<label class="col-sm-1 control-label">
												<span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span>
												<span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="该账号被占用，或包含特殊字符"></span>
											</label>
										</div>
										<div class="form-group">
											<label for="inputUsername" class="col-sm-2 control-label">用户名</label>
											<div class="col-sm-9">
												<input type="text" class="form-control" id="inputUsername" name="inputUsername" placeholder="用户名" required>
											</div>
											<label class="col-sm-1 control-label">
												<span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span>
												<span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="该用户名被占用，或包含特殊字符"></span>
											</label>
										</div>
										<div class="form-group">
											<label for="inputPassword" class="col-sm-2 control-label">密码</label>
											<div class="col-sm-9">
												<input type="password" class="form-control" id="inputPassword" name="inputPassword" placeholder="密码" required>
											</div>
											<label class="col-sm-1 control-label">
												<span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span>
												<span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="密码长度不足6位,或包含空格"></span>
											</label>
										</div>
										<div class="form-group">
											<label for="inputConfirmPas" class="col-sm-2 control-label">确认密码</label>
											<div class="col-sm-9">
												<input type="password" class="form-control" id="inputConfirmPas" name="inputConfirmPas" placeholder="密码" required>
											</div>
											<label class="col-sm-1 control-label">
												<span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span>
												<span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="密码不一致"></span>
											</label>
										</div>
										<div class="form-group">
											<label for="inputMark" class="col-sm-2 control-label">备注</label>
											<div class="col-sm-9">
												<input type="text" class="form-control" id="inputMark" name="inputMark" placeholder="备注" >
											</div>
											<label class="col-sm-1 control-label">
												<span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span>
												<span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="备注信息"></span>
											</label>
										</div>
										<div class="form-group">
											<label for="" class="col-sm-2 control-label">用户状态</label>
											<div class="col-sm-10">
												<div class="radio">
													<label>
														<input type="radio" name="optionsRadios" value="1" checked> 启用
													</label>
													<label>
														<input type="radio" name="optionsRadios" value="2"> 禁用
													</label>
												</div>
											</div>
										</div>
								</div>

								<div class="modal-footer">
									<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
									<button type="submit" class="btn btn-primary">保存</button>
								</div>
									</form>
							</div>
						</div>
					</div>

					<br />
					<div class="row"><br /> </div>
					<div class="table-responsive">
						<table id="myTable" class="table table-striped table-hover">
							<thead>
								<tr class="success">
									<th>id</th>
									<th>账号</th>
									<th>用户名</th>
									<th>备注</th>
									<th>状态</th>
									<th>操作</th>
								</tr>
							</thead>
							<tbody>	
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- Bootstrap core JavaScript
	  ================================================== -->
	  <!-- Placed at the end of the document so the pages load faster -->
	  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
	  <script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery.min.js"><\/script>')</script>
	  <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	  <!-- Just to make our placeholder images work. Don't actually copy the next line! -->
	  <script src="/assets/js/vendor/holder.min.js"></script>
	  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
	  <script src="/assets/js/ie10-viewport-bug-workaround.js"></script>
	  <!-- datatables js -->
	  <script src="http://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
	  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap3-dialog/1.34.7/js/bootstrap-dialog.min.js"></script>

	  <script>
		  $('#addForm').submit(function(envent){
			  envent.preventDefault();
			  var userid=$('#inputAccount').val();
			  var username=$('#inputUsername').val();
			  var password=$('#inputPassword').val();
			  var valid=$("input[name='optionsRadios']:checked").val();
			  var markinfo=$('#inputMark').val();
			  userid = $.trim(userid);
			  username = $.trim(username);
			  markinfo = $.trim(markinfo);
			  //password = $.trim(password);
			  if(userid == "" || username =="" || password == ""){
				  dialogAlert({
					"msg":"不允许输入空格字符串"
				  });
				  return;
			  }
			  if(hasSpecial(userid)){
				  return;
			  }else if(hasSpecial(username)){
				  return;
			  }else if(hasSpecial(markinfo)){
				  return;
			  }
			  if($('#inputPassword').val() != $('#inputConfirmPas').val() || $('#inputPassword').val().length<6){
				  dialogAlert({
					"msg":"密码不一致,或密码长度不足6位"
				  });
				  return;
			  }
			  $.ajax({
				  url:'/index/index/adduser',
				  type:'post',
				  dataType:'json',
				  data:{'inputAccount':userid,'inputUsername':username,'inputPassword':password,'inputMark':markinfo,'optionsRadios':valid},
				  beforeSend:function(){
				  },
				  error:function(){
					  dialogAlert({
						"msg":"erroe"
					  });
				  },
				  complete:function(){
					  //alert('complete');
				  },
				  success:function(data){
					  dialogAlert({
						"types":BootstrapDialog.TYPE_SUCCESS,
						"msg":data.info
					  });
					  $('#myModal').modal('hide');
					  table.ajax.reload();
				  }
			  });
		  });

		$('#inputPassword').change(function(){
	       	        setFlag('#inputPassword',$('#inputPassword').val().length>5);
		});
		$('#inputConfirmPas').change(function(){
	       	        setFlag('#inputConfirmPas',$('#inputConfirmPas').val().length>5 && $('#inputPassword').val() == $('#inputConfirmPas').val());
		});


		$('#inputUsername').change(function(){
			if($.trim($('#inputUsername').val()) == ""){
				$('#inputUsername').parent().next().children('.glyphicon').addClass('hidden');
				return;
			}
			if(hasSpecial($('#inputUsername').val(),true)){ 
				setFlag('#inputUsername',false);	
				return;
			}
			$.post('/index/index/checkUsername',{"user_name":$.trim($('#inputUsername').val())},function(data){
	   			setFlag('#inputUsername',data.info != "have");
			},'json');
		});

		$('#inputAccount').change(function(){
			if($.trim($('#inputAccount').val()) == ""){
				$('#inputAccount').parent().next().children('.glyphicon').addClass('hidden');
				return;
			}
			if(hasSpecial($('#inputAccount').val(),true)){ 
				setFlag('#inputAccount',false);	
				return;
			}
			$.post('/index/index/checkUserid',{"user_id":$.trim($('#inputAccount').val())},function(data){
	   			setFlag('#inputAccount',data.info != "have");
			},'json');
		});

		$('body').on('hidden.bs.modal','.modal',function(){
			$('#inputAccount').val("");
			$('#inputUsername').val("");
			$('#inputPassword').val("");
			$('#inputConfirmPas').val("");
			$('#inputMark').val("");
			$("input[name='optionsRadios']:eq(0)").prop("checked","checked");
			$('.modal .glyphicon').addClass('hidden');

		});

		var table;

		$(document).ready(function(){
			table=$('#myTable').DataTable({
				"language":{
					"search":"搜索",
					"info":"显示 _START_ 到 _END_ 行，共 _TOTAL_ 行。",
					"lengthMenu":"显示 _MENU_ 条记录",
					"paginate":{
						"previous":"上一页",
						"next":"下一页"
					}
				},
				"autoWidth":false,
				"columns":[
					{"data":"id"},
					{"data":"user_id"},
					{"data":"user_name"},
					{"data":"mark"},
					{
						"data":"valid",
						"render":function(data,type,row,meta){
	   						if(data == 1){
							   return '<span class="label label-success">启用</span>';
								  }else{
							   return '<span class="label label-danger">禁用</span>';
								  }
	   					}
					},
					{
						"data":"",
						"render":function(data,type,row,meta){
							var contents;
							 contents='  <span role="button" class="glyphicon glyphicon-edit text-info" onclick="modify('+row.id+',\''+row.user_id+'\',\''+row.user_name+'\',\''+row.mark+'\',\''+row.valid+'\')" title="修改"> </span>';
							 contents+='  <span role="button" class="glyphicon glyphicon-lock text-info" onclick="modifyPas('+row.id+',\''+row.user_id+'\',\''+row.user_name+'\')" title="修改密码"> </span>';
							 contents+=' <span role="button" class="glyphicon glyphicon-remove-circle text-info" onclick="del('+row.id+')" title="删除"> </span>';
							return contents;
	   					}
					}
					],
				"columnDefs":[
					{"searchable":false,"targets":[0,3,4]},
					{"visible":false,"targets":[0]},
					{"width":"100px","targets":[5]}
					],
				"ajax":{
					"type":"post",
					"dataType":"json",
					"contentType":"application/json",
					"url":"/index/index/getuser"
					
				}
			});
		});

		function del(id){
			BootstrapDialog.show({
				type:BootstrapDialog.TYPE_WARNING,
				title:'提示',
				message:'是否确认删除该用户？',
				buttons:[
					{
						label:'关闭',
						cssClass:'btn-default',
						action:function(dialogRef){
							dialogRef.close();
						}
					},
					{
					id:'btn-ok-d',
				//	icon:'glyphicon glyphicon-check',
					label:'确定',
					cssClass:'btn-warning',
					autospin:false,
					action:function(dialogRef){
						$.post('/index/index/deluser',{'user_id':id},function(data){
							if(data.info =="done"){
								dialogAlert({
									"types":BootstrapDialog.TYPE_SUCCESS,
									"msg":"删除成功"
								});
								dialogRef.close();
								table.ajax.reload();
							}else{
								dialogAlert({
									"msg":"删除失败"
								});
								dialogRef.close();
								table.ajax.reload();
							}
						},'json');
					}
				}]
			});
		}

		function modify(id,userid,username,mark,valid){
			var radios=' <div class="form-group"> <label for="" class="col-sm-2 control-label">用户状态</label> <div class="col-sm-10"> <div class="radio"> <label> <input type="radio" name="optionsRadiosM" value="1" checked> 启用 </label> <label> <input type="radio" name="optionsRadiosM" value="2"> 禁用 </label> </div> </div> </div>';
			if(valid =="2"){
				radios=' <div class="form-group"> <label for="" class="col-sm-2 control-label">用户状态</label> <div class="col-sm-10"> <div class="radio"> <label> <input type="radio" name="optionsRadiosM" value="1" > 启用 </label> <label> <input type="radio" name="optionsRadiosM" value="2" checked> 禁用 </label> </div> </div> </div>';
			}
			var marks=' <div class="form-group"><label for="inputMarkM" class="col-sm-2 control-label">备注信息</label> <div class="col-sm-9"> <input type="text" class="form-control" id="inputMarkM" name="inputMarkM" value="" placeholder="备注"> </div> <label class="col-sm-1 control-label">   </label> </div> '
			if(mark != null){
				marks=' <div class="form-group"><label for="inputMarkM" class="col-sm-2 control-label">备注信息</label> <div class="col-sm-9"> <input type="text" class="form-control" id="inputMarkM" name="inputMarkM" value="'+mark+'" placeholder="备注"> </div> <label class="col-sm-1 control-label">   </label> </div> '
			}
			var mainMsg= '<form class="form-horizontal" id="modifyForm" method="post"> <div class="form-group"> <label for="inputAccountM" class="col-sm-2 control-label">账号</label> <div class="col-sm-9"> <input type="text" class="form-control" id="inputAccountM" name="inputAccountM" value="'+userid+'" placeholder="账号" disabled="disabled" required> </div> <label class="col-sm-1 control-label">   </label> </div> <div class="form-group"> <label for="inputUsernameM" class="col-sm-2 control-label">用户名</label> <div class="col-sm-9"> <input type="text" class="form-control" id="inputUsernameM" name="inputUsernameM" value="'+username+'" placeholder="用户名" disabled="disabled" required> </div> <label class="col-sm-1 control-label">   </label> </div>'+marks+radios+' </form>';
			dialogShow({
				"titles":'信息修改',
				"msg":mainMsg,
				"actions2":function(shows){
					dialogShow({
						"types":BootstrapDialog.TYPE_WARNING,
						"msg":'是否修改该用户信息？',
						"btnsType2":'btn-warning',
						"actions2":function(shows1){
							shows1.close();
							if($.trim($('#inputMarkM').val()) == mark && $("input[name='optionsRadiosM']:checked").val() == valid){
								dialogAlert({
									"types":BootstrapDialog.TYPE_WARNING,
									"msg":'没有修改操作。',
								});
								return;
							}
							if(hasSpecial($('#inputMarkM').val())){ return;}
							$.post('/index/index/edituser',{"id":id,"inputMarkM":$('#inputMarkM').val(),"optionsRadiosM":$("input[name='optionsRadiosM']:checked").val()},function(data){
								if(data.info =="done"){
									dialogAlert({
										"types":BootstrapDialog.TYPE_SUCCESS,
										"msg":'修改成功。',
									});
									table.ajax.reload();
									mark=$('#inputMarkM').val();
									valid=$("input[name='optionsRadiosM']:checked").val();
								}else{
									dialogAlert({"msg":'修改失败'});
									table.ajax.reload();
								}
							},'json');
						}
					});
				}
			});
		}

		function modifyPas(id,userid,username){
			var mainMsg='<form class="form-horizontal"  method="post"> <div class="form-group"> <label for="" class="col-sm-2 control-label">账号</label> <div class="col-sm-9"> <input type="text" class="form-control"  value="'+userid+'" placeholder="账号" disabled="disabled" required> </div> <label class="col-sm-1 control-label">   </label> </div> <div class="form-group"> <label for="" class="col-sm-2 control-label">用户名</label> <div class="col-sm-9"> <input type="text" class="form-control"  value="'+username+'" placeholder="用户名" disabled="disabled" required> </div> <label class="col-sm-1 control-label">   </label> </div> <div class="form-group"> <label for="inputPasswordOld" class="col-sm-2 control-label">旧密码</label> <div class="col-sm-9"> <input type="password" class="form-control" id="inputPasswordOld" name="inputPasswordOld" value="" placeholder="旧密码" onchange="changeOldPas('+id+')" required > </div> <label class="col-sm-1 control-label">  <span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span> <span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="密码不正确"></span> </label> </div> <div class="form-group"> <label for="inputPasswordNew" class="col-sm-2 control-label">新密码</label> <div class="col-sm-9"> <input type="password" class="form-control" id="inputPasswordNew" name="inputPasswordNew" value="" placeholder="新密码" onchange="changeNewPas()" required > </div> <label class="col-sm-1 control-label">  <span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span> <span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="密码不足6位,或密码包含空格"></span> </label> </div> <div class="form-group"> <label for="inputPasswordConfirmNew" class="col-sm-2 control-label">确认密码</label> <div class="col-sm-9"> <input type="password" class="form-control" id="inputPasswordConfirmNew" name="inputPasswordConfirmNew" value="" placeholder="确认密码" onchange="changeConfirmNewPas()" required > </div> <label class="col-sm-1 control-label">  <span class="glyphicon glyphicon-ok text-success hidden" aria-hidden="true"></span> <span class="glyphicon glyphicon-remove text-danger hidden" aria-hidden="true" title="与上次密码输入不一致"></span> </label> </div></form>';
			dialogShow({
				"titles":'密码修改',
				"msg":mainMsg,
				"actions2":function(show){
					dialogShow({
						"types":BootstrapDialog.TYPE_WARNING,
						"msg":'是否修改密码',
						"btnsType2":'btn-warning',
						"actions2":function(show1){
							show1.close();
							if($('#inputPasswordConfirmNew').val().length<6 || $('#inputPasswordOld').val().length<6 || $('#inputPasswordNew').val() != $('#inputPasswordConfirmNew').val() ){
								dialogAlert({"msg":'修改失败，密码不足6位,或两次输入不一致,或包含空格。'});
								return;
							}
							$.post('/index/index/checkAndEditPas',{"id":id,"pas":$('#inputPasswordOld').val(),"pasN":$('#inputPasswordNew').val()},function(data){
								if(data.info==="opw"){
									dialogAlert({"msg":'原密码验证不正确'});
								}else if(data.info === "done"){
									dialogAlert({
										"types":BootstrapDialog.TYPE_SUCCESS,
										"msg":'修改成功'
									});
								}else{
									dialogAlert({"msg":'修改失败'});
								}
							},'json');
						}
					});
				}
			});
		}


		function changeOldPas(id){
			if($('#inputPasswordOld').val().length <6){
				setFlag('#inputPasswordOld',false); return;
			}
			$.post('/index/index/checkPas',{"id":id,"pas":$('#inputPasswordOld').val()},function(data){
				setFlag('#inputPasswordOld',data.info==="have"); 
			},'json');
		}
		
		function changeNewPas(){
			setFlag('#inputPasswordNew',$('#inputPasswordNew').val().length > 5);
		}

	      	function changeConfirmNewPas(){
			setFlag('#inputPasswordConfirmNew',$('#inputPasswordConfirmNew').val().length >5 && $('#inputPasswordNew').val() == $('#inputPasswordConfirmNew').val());
	      	}

		function hasSpecial(args)
	        {
		   	var flag =arguments[1]?arguments[1]:false;
			re=/select|update|delete|exec|count|'|"|=|;|>|<|%/i;
			if(re.test($.trim(args))){
		   		if(flag){
		   			return true;
		   		}
				BootstrapDialog.alert({
					type:BootstrapDialog.TYPE_WARNING,
					title:'提示',
					message:'请不要包含特殊字符。',
					closeable:true,
					buttonLabel:'确定'
				});
				//table.ajax.reload();
				return true;
			}
		   	return false;
		}   


      	        function setFlag(argName,argFlag){
		   	if(argFlag){
				$(argName).parent().next().children('.glyphicon-remove').addClass('hidden');
				$(argName).parent().next().children('.glyphicon-ok').removeClass('hidden');
		   	}
		   	else{
				$(argName).parent().next().children('.glyphicon-ok').addClass('hidden');
				$(argName).parent().next().children('.glyphicon-remove').removeClass('hidden');
		   	}
	        }


		function dialogAlert(args){
			args.titles = args.titles?args.titles:'提示';
		   	args.btns = args.btns?args.btns:'确定';
		   	args.types= args.types?args.types:BootstrapDialog.TYPE_DANGER;
		   	args.msg= args.msg?args.msg:'错误';
			BootstrapDialog.alert({
				type:args.types,
				title:args.titles,
				message:args.msg,
				closeable:true,
				buttonLabel:args.btns
			});
		}
							
		function dialogShow(args){
		   	args.types= args.types?args.types:BootstrapDialog.TYPE_INFO;
			args.titles = args.titles?args.titles:'提示';
		   	args.msg = args.msg?args.msg:'...';
		   	args.btns1 = args.btns1?args.btns1:'关闭';
		   	args.btns2 = args.btns2?args.btns2:'确定';
		   	args.btnsType1 = args.btnsType1?args.btnsType1:'btn-defailt';
		   	args.btnsType2 = args.btnsType2?args.btnsType2:'btn-info';
		   	args.actions2 = args.actions2?args.actions2:function(dialogRef){};
			BootstrapDialog.show({
				type:args.types,
				title:args.titles,
				message:args.msg,
				buttons:[
					{
						label:args.btns1,
						cssClass:args.btnsType1,
						action:function(dialogRef){
							dialogRef.close();
						}
					},
					{
						label:args.btns2,
						cssClass:args.btnsType2,
						autospin:false,
						action:args.actions2
		   			}]
			});
		}
	  </script>
	</body>
</html>
